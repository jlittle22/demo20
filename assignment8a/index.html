<!DOCTYPE html>
<html>
<head>
	<title>Display JSON Data</title>
    <style type="text/css">
        table {
            border: 1px solid black;
        }

        td {
            border-bottom: 1px dashed grey;
            padding: 4px 20px;
        }        
    </style>
    <script type = "text/javascript" 
        src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
    </script>	
    <script type="text/javascript">
        // Creates set of genres in the song list and stores.
        // Returns string version of genres array.
        function processGenresArray(genres_arr) {
            for (var i = 0; i < genres_arr.length; i++) {
                this.genres.add(genres_arr[i]);
            }

            return genres_arr.join(', ');
        }

        // Makes a <td> containing info
        function makeTableD(info) {
            return "<td>" + info + "</td>";
        }

        // Makes a <tr> string containing all song info
        function constructTableRow(title, opb, genre, year, num) {
            tr_str = "<tr id=row" + num + ">" + makeTableD(title) +
                     makeTableD(opb) + makeTableD(processGenresArray(genre)) + 
                     makeTableD(year) + "</tr>";
            $('#table tr:last').after(tr_str);
        }

        // Checks whether two arrays contain a shared element
        function arraysIntersect(arr1, arr2) {
            for (var i = 0; i < arr1.length; i++) {
                if (arr2.includes(arr1[i])) {
                    return true;
                }
            }
            return false;
        }        

        // Converts a JSON song list object into an HTML table exluding
        // genres found in avoids
        function displayAsTable(data, avoids) {
            this.genres = new Set();
            for (var i = 0; i < data.song_list.length; i++) {
                if (!arraysIntersect(avoids, data.song_list[i].genre)) {
                    constructTableRow(data.song_list[i].title,
                                      data.song_list[i].opb,
                                      data.song_list[i].genre,
                                      data.song_list[i].year,
                                      i);
                }
            }
        }

        // Creates an <option> containing info
        function makeOption(info) {
            return "<option value=\"" + info + "\">" + info + "</option>";
        }

        // Appends an option to the genre selection input
        function constructGenreOptions() {
            this.genres.forEach(function(elem) {
                $('#genres').append(makeOption(elem));
            })
        }
 
        // Processes selection form and re-displays filtered table
        function processForm() {
            selection = $("#genres :selected").text();
            var count = $('#table tr').length;
            for (var i = 1; i < count; i++) {
                $('#table tr:last').remove();
            }

            $.getJSON('song-list.json', function(data) {
                displayAsTable(data, [selection]);
            });
            
            return false;
        }

		window.onload = function() {
			$.getJSON('song-list.json', function(data) {
                this.json_obj = data;
                $('#raw').html(JSON.stringify(data));
                displayAsTable(data, []);
                constructGenreOptions();
            });
		}
	</script>
</head>
<body>
    <h1>Raw JSON Content</h1>
    <p id=raw></p>

    <h1>User Friendly Content</h1>
    <form id="filter" onsubmit="return processForm();">
        <label for="genres">Choose a genre:</label>
        <select id="genres" name="genres">
          <option value="none">--</option>
        </select>
        <input type="submit" name="submit_button" value="Filter">
    </form>
    <table id="table">
        <tr id="headers">
            <th>Title</th>
            <th>OPB</th>
            <th>Genre(s)</th>
            <th>Year</th>
        </tr>
    </table>

</body>
</html>